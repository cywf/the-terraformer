---
import Layout from '../layouts/Layout.astro';
import { readFile } from 'node:fs/promises';
import { join } from 'node:path';

const baseUrl = import.meta.env.BASE_URL;

// Try to read README.md from the repository root
let readmeContent = '';
try {
  const readmePath = join(process.cwd(), '..', 'README.md');
  readmeContent = await readFile(readmePath, 'utf-8');
} catch (error) {
  console.error('Failed to read README.md:', error);
}

// Simple markdown to HTML converter (for basic formatting)
function markdownToHtml(md: string): string {
  let html = md;
  
  // Replace image paths
  html = html.replace(/!\[([^\]]*)\]\(assets\/images\/([^)]+)\)/g, `![$1](${baseUrl}/images/$2)`);
  
  // Headers
  html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
  
  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  
  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="link link-primary" target="_blank" rel="noopener noreferrer">$1</a>');
  
  // Code blocks
  html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Lists
  html = html.replace(/^\* (.+)$/gim, '<li>$1</li>');
  html = html.replace(/^- (.+)$/gim, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
  
  // Paragraphs
  html = html.split('\n\n').map(p => {
    if (!p.match(/^<[h|u|o|p|l|d]/)) {
      return `<p>${p}</p>`;
    }
    return p;
  }).join('\n');
  
  return html;
}

const htmlContent = markdownToHtml(readmeContent);
---

<Layout 
  title="Documentation"
  description="Documentation and guides for The Terraformer"
  showBreadcrumbs={true}
  breadcrumbs={[{ label: 'Docs', href: `${baseUrl}/docs` }]}
>
  <div class="container mx-auto px-4 py-12 max-w-5xl">
    <!-- Header -->
    <div class="flex justify-between items-start mb-8">
      <div>
        <h1 class="text-4xl font-bold mb-4">Documentation</h1>
        <p class="text-xl opacity-80">
          Learn how to use The Terraformer for infrastructure automation
        </p>
      </div>
      <a 
        href="https://github.com/cywf/the-terraformer/blob/main/README.md" 
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-outline btn-sm gap-2"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
        Open in GitHub
      </a>
    </div>

    {readmeContent ? (
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Table of Contents -->
        <div class="lg:col-span-1">
          <div class="sticky top-20 bg-base-200 rounded-lg p-4">
            <h3 class="font-bold mb-4">On This Page</h3>
            <nav class="space-y-2 text-sm" id="toc">
              <!-- TOC will be generated by JS -->
            </nav>
          </div>
        </div>

        <!-- Content -->
        <article class="lg:col-span-3 prose prose-lg max-w-none markdown-content">
          <div set:html={htmlContent}></div>
        </article>
      </div>
    ) : (
      <div class="text-center py-16">
        <div class="mb-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold mb-4">Documentation Coming Soon</h2>
        <p class="text-lg opacity-80 mb-8">
          We're working on comprehensive documentation. In the meantime, check out the README on GitHub.
        </p>
        <div class="flex gap-4 justify-center">
          <a 
            href="https://github.com/cywf/the-terraformer/blob/main/README.md" 
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-primary"
          >
            View README
          </a>
          <a href={`${baseUrl}/blueprints`} class="btn btn-outline">
            Browse Blueprints
          </a>
        </div>
      </div>
    )}
  </div>

  <script>
    // Generate table of contents
    document.addEventListener('DOMContentLoaded', () => {
      const content = document.querySelector('.markdown-content');
      const toc = document.getElementById('toc');
      
      if (!content || !toc) return;
      
      const headings = content.querySelectorAll('h2, h3');
      if (headings.length === 0) {
        toc.innerHTML = '<p class="text-xs opacity-60">No sections found</p>';
        return;
      }
      
      const tocList = document.createElement('ul');
      tocList.className = 'space-y-2';
      
      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;
        
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.textContent = heading.textContent || '';
        a.className = 'link link-hover opacity-70 hover:opacity-100';
        
        if (heading.tagName === 'H3') {
          a.className += ' ml-4 text-xs';
        }
        
        li.appendChild(a);
        tocList.appendChild(li);
      });
      
      toc.innerHTML = '';
      toc.appendChild(tocList);
    });
  </script>
</Layout>

<style>
  .markdown-content {
    @apply text-base-content;
  }
  
  .markdown-content h1 {
    @apply text-4xl font-bold mt-8 mb-6;
  }
  
  .markdown-content h2 {
    @apply text-3xl font-bold mt-8 mb-4 border-b border-base-300 pb-2;
  }
  
  .markdown-content h3 {
    @apply text-2xl font-bold mt-6 mb-3;
  }
  
  .markdown-content p {
    @apply mb-4 leading-relaxed;
  }
  
  .markdown-content ul {
    @apply list-disc ml-6 mb-4 space-y-2;
  }
  
  .markdown-content ol {
    @apply list-decimal ml-6 mb-4 space-y-2;
  }
  
  .markdown-content li {
    @apply mb-2;
  }
  
  .markdown-content code {
    @apply bg-base-300 px-2 py-1 rounded text-accent text-sm;
  }
  
  .markdown-content pre {
    @apply bg-base-300 p-4 rounded-lg overflow-x-auto my-6;
  }
  
  .markdown-content pre code {
    @apply bg-transparent p-0 text-sm;
  }
  
  .markdown-content a {
    @apply link link-primary;
  }
  
  .markdown-content img {
    @apply rounded-lg shadow-lg my-6 max-w-full;
  }
  
  .markdown-content strong {
    @apply font-semibold text-primary;
  }
  
  .markdown-content blockquote {
    @apply border-l-4 border-primary pl-4 italic opacity-80 my-4;
  }
</style>
